<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <title>ToneSeer - Spotify Login</title>
</head>
<body class="container">
    <h1 class="p-3">Login with Spotify</h1>
  <button id="loginButton" class="btn tn-primary">Login</button>

  <script>
    const clientId = "1d13e13876ab42d6aa28fea0a53a3d18";
    const redirectUri = "https://tone-seer-spotify-login.vercel.app/api/callback"; // your server endpoint
    const scopes = "user-read-private user-read-email";

    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get("device_id");
    if (!deviceId) alert("No device_id found!");

    document.getElementById("loginButton").addEventListener("click", () => {
      const state = Math.random().toString(36).substring(2, 15);
      const codeVerifier = Math.random().toString(36).substring(2, 100);
      localStorage.setItem("code_verifier", codeVerifier);

      // Generate code challenge
      async function sha256(plain) {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        const hash = await crypto.subtle.digest("SHA-256", data);
        return btoa(String.fromCharCode(...new Uint8Array(hash)))
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");
      }

      sha256(codeVerifier).then(codeChallenge => {
      // ðŸ‘‡ Pack device_id + nonce into state
      const stateObj = { device_id: deviceId, nonce: nonce };
      const stateParam = encodeURIComponent(JSON.stringify(stateObj));

      const url =
        `https://accounts.spotify.com/authorize?` +
        `response_type=code` +
        `&client_id=${clientId}` +
        `&scope=${encodeURIComponent(scopes)}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&state=${stateParam}` +
        `&code_challenge_method=S256` +
        `&code_challenge=${codeChallenge}`;

      window.location = url;
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
</body>
</html>